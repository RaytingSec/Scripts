#!/bin/bash
# OpenVPN script
# Connects to vpn via openvpn, includes tools for configuring DNS

#CONFIG=nl01-443-128b.ovpn
#CONFIG=ro01-443-128b.ovpn
#CONFIG=ro-256b.ovpn
#CONFIG=deprecated/us-128b.ovpn
#CONFIG=us-ca01-128b.ovpn
#CONFIG=us-ca01-443-128b.ovpn
CONFIG=us-443-128b.ovpn
#CONFIG=us211.nordvpn.com.udp1194.ovpn
#CONFIG=us237.nordvpn.com.tcp443.ovpn
#CONFIG=us-ca2.nordvpn.com.tcp443.ovpn
#CONFIG=nl2.nordvpn.com.tcp443.ovpn
# should implement complex parameter parsing instead of comments for every config :(

AUTH=login
DIR=$HOME/.vpn

# DNS
set_dns () {
    # Google
    printf 'nameserver 8.8.8.8\nnameserver 8.8.4.4\n' | sudo -E tee /etc/resolv.conf > /dev/null
    # OpenDNS
    # printf 'nameserver 208.67.222.222\nnameserver 208.67.220.220\n' | sudo -E tee /etc/resolv.conf > /dev/null
}

# Connect to vpn
vpn_connect () {
    sudo pwd >> /dev/null # get sudo priv
    firefox -private dnsleaktest.com & # Test vpn connection
    cd $DIR
    sudo openvpn --config "$CONFIG" --auth-user-pass "$AUTH" --auth-nocache
}

# Default start vpn
if [[ "$1" == "" ]]; then
    vpn_connect
# prints resolv.conf contents
elif [[ "$1" == "-c" ]]; then
    cat /etc/resolv.conf
# config dns
elif [[ "$1" == "-d" ]]; then
    set_dns
# force kill
elif [[ "$1" == "-k" ]]; then
    sudo pkill -KILL vpn
# help
elif [[ "$1" == "--help" ]]; then # help text
    echo "Utilities for connecting to a vpn using OpenVPN"
    echo "Options:"
    echo "    -c        Show current resolv.conf"
    echo "    -d        Change DNS servers to Google's 8.8.8.8 and 8.8.4.4"
    echo "    -k        Kill the vpn connection"
    echo "    (blank)   connect to vpn and without setting dns"
    echo ""
# unknown
else
    echo "option '$1' not recognized."
    echo "'--help' gives usage information."
fi

